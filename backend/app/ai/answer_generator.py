from app.ai.deepseek_client import get_client
from app.schemas.ai import AnswerSuggestion


# Краткий и понятный URL сайта без UTM‑меток
SUPPORT_SITE_URL = "https://kazaktele.com/"


def generate_answer(
    ticket_text: str,
    language: str = "ru",
    faq_snippet: str | None = None,
    request_type: str | None = None,
) -> AnswerSuggestion:
    client = get_client()
    if client is None:
        # Простейший фолбэк
        return AnswerSuggestion(
            answer="Ваше обращение зарегистрировано. Специалист свяжется с вами в ближайшее время.",
            answer_language=language,
        )

    if language == "ru":
        lang_instruction = (
            "Пиши ответ строго на русском языке. "
            "Не используй английский язык и не вставляй английские слова. "
            "Не предлагай сайт компании как универсальное решение и не отправляй пользователя «на сайт» "
            "без серьёзной причины. "
            f"Если в рамках правил ниже всё‑таки нужно указать сайт, используй короткий адрес: {SUPPORT_SITE_URL} "
            "и не используй расплывчатые фразы вроде «на сайте» без ссылки."
        )
    elif language == "kk":
        lang_instruction = (
            "Жауапты қатаң қазақ тілінде жаз. "
            "Ағылшын тілін қолданба. "
            "Сайтты барлық жағдайда ұсынба, тек шынымен керек болғанда ғана атап өт. "
            f"Егер сайтты көрсету қажет болса, қысқа сілтемені пайдалан: {SUPPORT_SITE_URL}."
        )
    else:
        lang_instruction = f"Write the answer strictly in {language} language."

    # Нормализуем старые значения (difficulty/proposal/job) к новым
    normalized_type = request_type
    if request_type == "proposal":
        normalized_type = "feedback"
    elif request_type == "job":
        normalized_type = "career"
    elif request_type == "difficulty":
        normalized_type = "problem"

    type_instruction = ""
    if normalized_type == "feedback":
        type_instruction = (
            "Тип обращения: предложение или отзыв, это не техническая неисправность. "
            "Не описывай диагностику неполадок и не отвечай как на инцидент. "
            "Кратко поблагодари за идею/обратную связь и опиши, что предложение будет рассмотрено. "
            f"Дополнительно можешь предложить оставить предложение через форму на сайте {SUPPORT_SITE_URL} "
            "или по другому каналу, но сайт не должен заменять сам ответ."
        )
    elif normalized_type == "career":
        type_instruction = (
            "Тип обращения: работа и стажировки. "
            "Дай короткий ответ о том, где посмотреть актуальные вакансии и стажировки "
            f"и куда отправить резюме (например, раздел «Карьера» на сайте {SUPPORT_SITE_URL} или email)."
        )
    elif normalized_type == "problem":
        type_instruction = (
            "Тип обращения: проблема, что-то не работает. "
            "Сконцентрируйся на конкретных шагах решения проблемы: сначала 2–4 простых и понятных шага "
            "от самых базовых (проверить кабели, перезагрузить роутер/оборудование) до следующих "
            "(проверить индикаторы, сделать сброс кнопкой Reset и т.п.). "
            "Не отправляй пользователя на сайт, если он сам явно не просил адрес сайта или ссылка не критична "
            "для решения. Если из текста видно, что пользователь уже всё перепробовал и удалённо помочь нельзя, "
            "в конце можешь предложить обратиться в поддержку по телефону или через сайт, но только после шагов."
        )
    elif normalized_type == "question":
        type_instruction = (
            "Тип обращения: вопрос или запрос информации. "
            "Дай прямой и краткий ответ на вопрос. "
            "Не направляй пользователя на сайт, кроме случаев, когда он прямо просит адрес сайта "
            "или конкретную страницу."
        )
    elif normalized_type == "partner":
        type_instruction = (
            "Тип обращения: партнёрство и сотрудничество. "
            "Кратко опиши, по каким каналам можно обсудить партнёрство "
            f"(контактный email, форма на сайте {SUPPORT_SITE_URL}, ответственный отдел и т.п.)."
        )

    system_prompt = (
        "Ты сотрудник службы поддержки IT. "
        "Отвечай очень кратко и по делу, без воды, без приветствий и лишних фраз. "
        "Максимум 4–5 коротких предложений. "
        "Сначала дай понятные шаги или основную информацию по запросу, "
        "затем в конце задай один короткий уточняющий вопрос, помог ли ответ или нужна ли дополнительная помощь. "
        f"Если пользователь прямо просит адрес сайта (например, «какой у вас сайт», «скиньте сайт»), "
        f"обязательно укажи короткий адрес {SUPPORT_SITE_URL}. "
        f"{lang_instruction} "
        f"{type_instruction} "
        "Если есть подсказка из базы знаний, опирайся на неё и не придумывай фактов, которых нет в подсказке. "
        "Если подсказки нет, дай базовые шаги, но тоже кратко."
    )

    user_content = f"Текст обращения:\n{ticket_text}\n"
    if faq_snippet:
        user_content += f"\nПодсказка из базы знаний:\n{faq_snippet}\n"

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_content},
    ]
    answer_text = client.chat(messages, temperature=0.1)
    return AnswerSuggestion(answer=answer_text.strip(), answer_language=language)
